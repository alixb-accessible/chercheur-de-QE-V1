<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracteur Questions Parlementaires - Handicap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
    <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, 
                #4a4a4a 0%, #4a4a4a 14.28%,
                #22c55e 14.28%, #22c55e 28.56%,
                #3b82f6 28.56%, #3b82f6 42.84%,
                #ffffff 42.84%, #ffffff 57.12%,
                #fbbf24 57.12%, #fbbf24 71.4%,
                #dc2626 71.4%, #dc2626 85.68%,
                #4a4a4a 85.68%, #4a4a4a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 400;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-family: 'Lexend', sans-serif;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        .status {
            padding: 20px 30px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 20px 30px;
            border-radius: 8px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            border-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .results {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .question-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .question-link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }

        h2, h3 {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .warning-box p {
            color: #856404;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Extracteur de Questions Parlementaires</h1>
            <p class="subtitle">Handicap - Assemblée Nationale & Sénat (2017-2025)</p>
        </header>

        <div class="controls">
            <div class="warning-box">
                <h3>Important : Limitation de cet outil</h3>
                <p><strong>Cet outil fournit les RÉFÉRENCES des questions</strong> (numéro, date, auteur, thème, lien). Pour accéder au <strong>texte complet des questions et réponses</strong>, vous devrez cliquer sur chaque lien individuellement. <strong>Note :</strong> L'extraction des thèmes prend un peu plus de temps car l'outil visite chaque page de question pour récupérer cette information.</p>
            </div>

            <div class="control-group">
                <label for="keywords">Mots-clés à rechercher (séparés par des virgules) :</label>
                <input type="text" id="keywords" value="handicap,handicapé,handicapée,AAH,MDPH,PCH,RQTH,ESAT,IME,AESH,autisme,autiste" placeholder="handicap, AAH, MDPH..." aria-describedby="keywords-help">
                <small id="keywords-help">Entrez plusieurs mots-clés séparés par des virgules pour élargir la recherche</small>
            </div>

            <div class="control-group">
                <label for="dateDebut">Date de début :</label>
                <input type="date" id="dateDebut" value="2017-06-01" aria-describedby="date-help">
            </div>

            <div class="control-group">
                <label for="dateFin">Date de fin :</label>
                <input type="date" id="dateFin" aria-describedby="date-help">
                <small id="date-help">Période de recherche des questions publiées</small>
            </div>

            <div class="control-group">
                <label for="assemblee">Assemblée :</label>
                <select id="assemblee" aria-describedby="assemblee-help">
                    <option value="toutes">Les deux assemblées</option>
                    <option value="an">Assemblée Nationale uniquement</option>
                    <option value="senat">Sénat uniquement</option>
                </select>
                <small id="assemblee-help">Choisissez quelle(s) assemblée(s) interroger</small>
            </div>

            <div class="btn-group">
                <button onclick="lancerExtraction()" id="btnExtract" aria-label="Lancer l'extraction des questions parlementaires">Lancer l'extraction</button>
                <button onclick="exporterCSV()" id="btnCSV" disabled aria-label="Exporter les résultats en format CSV">Exporter en CSV</button>
                <button onclick="exporterExcel()" id="btnExcel" disabled aria-label="Exporter les résultats en format Excel">Exporter en Excel</button>
            </div>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <div class="results" id="results" style="display:none;">
            <h2>Statistiques</h2>
            <div class="stats" id="statsContainer" role="region" aria-label="Statistiques des questions trouvées"></div>

            <div class="filters">
                <h3>Filtrer les résultats :</h3>
                <div class="filter-row">
                    <div>
                        <label for="filterStatut">Statut :</label>
                        <select id="filterStatut" onchange="appliquerFiltres()" aria-label="Filtrer par statut de la question">
                            <option value="">Tous</option>
                            <option value="Répondu">Répondu</option>
                            <option value="En attente">En attente</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAssemblee">Assemblée :</label>
                        <select id="filterAssemblee" onchange="appliquerFiltres()" aria-label="Filtrer par assemblée">
                            <option value="">Toutes</option>
                            <option value="AN">Assemblée Nationale</option>
                            <option value="Sénat">Sénat</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAnnee">Année :</label>
                        <select id="filterAnnee" onchange="appliquerFiltres()" aria-label="Filtrer par année de publication">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                </div>
            </div>

            <h2>Questions trouvées</h2>
            <div style="overflow-x: auto;">
                <table id="questionsTable" role="table" aria-label="Tableau des questions parlementaires sur le handicap">
                    <thead>
                        <tr>
                            <th scope="col">Assemblée</th>
                            <th scope="col">Numéro</th>
                            <th scope="col">Date</th>
                            <th scope="col">Auteur</th>
                            <th scope="col">Thème</th>
                            <th scope="col">Question</th>
                            <th scope="col">Statut</th>
                            <th scope="col">Lien</th>
                        </tr>
                    </thead>
                    <tbody id="questionsBody"></tbody>
                </table>
            </div>
        </div>

        <footer style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 3px solid #e9ecef; margin-top: 40px;">
            <p style="color: #666; font-size: 0.9em;">Propulsé par Ti Racoon</p>
        </footer>
    </div>

    <script>
        let toutesLesQuestions = [];
        let questionsFiltrees = [];

        // Initialiser la date du jour
        document.getElementById('dateFin').value = new Date().toISOString().split('T')[0];

        function afficherStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status show ' + type;
        }

        async function lancerExtraction() {
            const btn = document.getElementById('btnExtract');
            btn.disabled = true;
            btn.textContent = 'Extraction en cours...';
            
            toutesLesQuestions = [];
            document.getElementById('results').style.display = 'none';
            
            afficherStatus('Recherche de questions parlementaires via les API NosDéputés.fr et NosSénateurs.fr...', 'info');

            try {
                const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim());
                const dateDebut = document.getElementById('dateDebut').value.replace(/-/g, '');
                const dateFin = document.getElementById('dateFin').value.replace(/-/g, '');
                const assemblee = document.getElementById('assemblee').value;

                // Extraction pour chaque mot-clé
                for (const keyword of keywords) {
                    if (assemblee === 'toutes' || assemblee === 'an') {
                        await extraireNosDePutes(keyword, dateDebut, dateFin);
                    }
                    if (assemblee === 'toutes' || assemblee === 'senat') {
                        await extraireNosSenateurs(keyword, dateDebut, dateFin);
                    }
                }

                if (toutesLesQuestions.length === 0) {
                    afficherStatus('Aucune question trouvée avec les critères sélectionnés.', 'warning');
                } else {
                    afficherStatus(`Extraction terminée. ${toutesLesQuestions.length} questions trouvées.`, 'success');
                    afficherResultats();
                    document.getElementById('btnCSV').disabled = false;
                    document.getElementById('btnExcel').disabled = false;
                }
            } catch (error) {
                afficherStatus('Erreur lors de l\'extraction : ' + error.message, 'error');
                console.error(error);
            }

            btn.disabled = false;
            btn.textContent = 'Lancer l\'extraction';
        }

        async function extraireNosDePutes(keyword, dateDebut, dateFin) {
            try {
                const url = `https://www.nosdeputes.fr/recherche/${encodeURIComponent(keyword)}?object_name=QuestionEcrite&date=${dateDebut},${dateFin}`;
                
                afficherStatus(`Recherche "${keyword}" sur NosDéputés.fr...`, 'info');
                
                const response = await fetch(url);
                const html = await response.text();
                
                // Parser le HTML pour extraire les questions
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const items = doc.querySelectorAll('.search-result');
                
                for (const item of items) {
                    const lienElement = item.querySelector('a');
                    if (!lienElement) continue;
                    
                    const lien = 'https://www.nosdeputes.fr' + lienElement.getAttribute('href');
                    const titre = lienElement.textContent.trim();
                    const meta = item.querySelector('.search-result-info');
                    
                    // Récupérer le thème depuis la page de la question
                    const theme = await recupererThemeQuestion(lien);
                    
                    toutesLesQuestions.push({
                        assemblee: 'AN',
                        numero: extractNumero(lien),
                        date: extractDate(meta ? meta.textContent : ''),
                        auteur: extractAuteur(meta ? meta.textContent : ''),
                        theme: theme || keyword,
                        question: titre,
                        statut: 'Répondu',
                        lien: lien
                    });
                }
            } catch (error) {
                console.error(`Erreur NosDéputés pour "${keyword}":`, error);
            }
        }
        
        async function recupererThemeQuestion(url) {
            try {
                const response = await fetch(url);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Chercher le thème dans différents emplacements possibles
                const themeElement = doc.querySelector('.tags a, .rubrique, h2');
                if (themeElement) {
                    return themeElement.textContent.trim();
                }
                
                // Sinon chercher dans le contenu
                const content = doc.querySelector('.content, .question-content');
                if (content) {
                    const text = content.textContent;
                    const match = text.match(/Thème\s*:\s*([^\n]+)|Rubrique\s*:\s*([^\n]+)/i);
                    if (match) {
                        return (match[1] || match[2]).trim();
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Erreur récupération thème:', error);
                return null;
            }
        }

        async function extraireNosSenateurs(keyword, dateDebut, dateFin) {
            try {
                const url = `https://www.nossenateurs.fr/recherche/${encodeURIComponent(keyword)}?object_name=QuestionEcrite&date=${dateDebut},${dateFin}`;
                
                afficherStatus(`Recherche "${keyword}" sur NosSénateurs.fr...`, 'info');
                
                const response = await fetch(url);
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const items = doc.querySelectorAll('.search-result');
                
                for (const item of items) {
                    const lienElement = item.querySelector('a');
                    if (!lienElement) continue;
                    
                    const lien = 'https://www.nossenateurs.fr' + lienElement.getAttribute('href');
                    const titre = lienElement.textContent.trim();
                    const meta = item.querySelector('.search-result-info');
                    
                    // Récupérer le thème depuis la page de la question
                    const theme = await recupererThemeQuestion(lien);
                    
                    toutesLesQuestions.push({
                        assemblee: 'Sénat',
                        numero: extractNumero(lien),
                        date: extractDate(meta ? meta.textContent : ''),
                        auteur: extractAuteur(meta ? meta.textContent : ''),
                        theme: theme || keyword,
                        question: titre,
                        statut: 'Répondu',
                        lien: lien
                    });
                }
            } catch (error) {
                console.error(`Erreur NosSénateurs pour "${keyword}":`, error);
            }
        }

        function extractNumero(lien) {
            const match = lien.match(/(\d+)QE/);
            return match ? match[1] : 'N/A';
        }

        function extractDate(texte) {
            const match = texte.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            return match ? `${match[3]}-${match[2]}-${match[1]}` : '';
        }

        function extractAuteur(texte) {
            const match = texte.match(/par\s+([^,]+)/i);
            return match ? match[1].trim() : '';
        }

        function afficherResultats() {
            questionsFiltrees = [...toutesLesQuestions];
            
            // Statistiques
            const totalQuestions = toutesLesQuestions.length;
            const avecReponse = toutesLesQuestions.filter(q => q.statut === 'Répondu').length;
            const sansReponse = totalQuestions - avecReponse;
            const questionsAN = toutesLesQuestions.filter(q => q.assemblee === 'AN').length;
            const questionsSénat = toutesLesQuestions.filter(q => q.assemblee === 'Sénat').length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalQuestions}</div>
                    <div class="stat-label">Questions totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avecReponse}</div>
                    <div class="stat-label">Avec réponse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${sansReponse}</div>
                    <div class="stat-label">Sans réponse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${questionsAN}</div>
                    <div class="stat-label">Assemblée Nationale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${questionsSénat}</div>
                    <div class="stat-label">Sénat</div>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = statsHTML;

            // Peupler le filtre année
            const annees = [...new Set(toutesLesQuestions.map(q => q.date.substring(0, 4)))].sort().reverse();
            const filterAnnee = document.getElementById('filterAnnee');
            filterAnnee.innerHTML = '<option value="">Toutes</option>';
            annees.forEach(annee => {
                filterAnnee.innerHTML += `<option value="${annee}">${annee}</option>`;
            });

            afficherTableau();
            document.getElementById('results').style.display = 'block';
        }

        function afficherTableau() {
            const tbody = document.getElementById('questionsBody');
            tbody.innerHTML = '';

            questionsFiltrees.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.assemblee}</td>
                    <td>${q.numero}</td>
                    <td>${q.date}</td>
                    <td>${q.auteur}</td>
                    <td>${q.theme}</td>
                    <td>${q.question.substring(0, 100)}...</td>
                    <td><span class="badge ${q.statut === 'Répondu' ? 'badge-success' : 'badge-warning'}">${q.statut}</span></td>
                    <td><a href="${q.lien}" target="_blank" class="question-link" aria-label="Voir la question complète numéro ${q.numero}">Voir</a></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function appliquerFiltres() {
            const filterStatut = document.getElementById('filterStatut').value;
            const filterAssemblee = document.getElementById('filterAssemblee').value;
            const filterAnnee = document.getElementById('filterAnnee').value;

            questionsFiltrees = toutesLesQuestions.filter(q => {
                if (filterStatut && q.statut !== filterStatut) return false;
                if (filterAssemblee && q.assemblee !== filterAssemblee) return false;
                if (filterAnnee && !q.date.startsWith(filterAnnee)) return false;
                return true;
            });

            afficherTableau();
        }

        function exporterCSV() {
            const csv = Papa.unparse(questionsFiltrees);
            telechargerFichier(csv, 'questions_handicap.csv', 'text/csv');
        }

        function exporterExcel() {
            const ws = XLSX.utils.json_to_sheet(questionsFiltrees);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Questions');
            XLSX.writeFile(wb, 'questions_handicap.xlsx');
        }

        function telechargerFichier(contenu, nomFichier, type) {
            const blob = new Blob([contenu], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomFichier;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
