<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracteur Questions Parlementaires - Handicap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
    <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(135deg, 
                #4a4a4a 0%, #4a4a4a 14.28%,
                #22c55e 14.28%, #22c55e 28.56%,
                #3b82f6 28.56%, #3b82f6 42.84%,
                #ffffff 42.84%, #ffffff 57.12%,
                #fbbf24 57.12%, #fbbf24 71.4%,
                #dc2626 71.4%, #dc2626 85.68%,
                #4a4a4a 85.68%, #4a4a4a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 400;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-family: 'Lexend', sans-serif;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }
.status {
            padding: 20px 30px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            border-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .status.info {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 400;
        }

        .stat-section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-section h3 {
            margin-bottom: 15px;
            color: #1e3c72;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .stat-list {
            list-style: none;
            padding: 0;
        }

        .stat-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-list li:last-child {
            border-bottom: none;
        }

        .stat-list .name {
            font-weight: 600;
            flex: 1;
            min-width: 200px;
        }

        .stat-list .value {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .stat-list .detail {
            color: #666;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            max-width: 300px;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .question-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .question-link:hover {
            text-decoration: underline;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        h2, h3 {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .info-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .info-box p, .info-box ul {
            color: #0c5460;
            line-height: 1.6;
        }

        .info-box ul {
            margin: 10px 0 10px 20px;
        }

        .info-box a {
            color: #0056b3;
            font-weight: 600;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 3px solid #e9ecef;
        }

        footer p {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Extracteur de Questions Parlementaires</h1>
            <p class="subtitle">Handicap - Assemblée Nationale & Sénat (2017-2025)</p>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('import')">Import de données</div>
            <div class="tab" onclick="switchTab('stats')">Statistiques</div>
            <div class="tab" onclick="switchTab('resultats')">Résultats détaillés</div>
        </div>
<!-- ONGLET IMPORT -->
        <div id="tab-import" class="tab-content active">
            <div class="info-box">
                <h3>Comment utiliser cet outil</h3>
                <p><strong>Téléchargez les fichiers Open Data officiels de l'Assemblée Nationale :</strong></p>
                <ul>
                    <li><a href="https://data.assemblee-nationale.fr/static/openData/repository/16/questions/questions_ecrites/Questions_ecrites.json.zip" target="_blank">16e législature (2022-2024)</a> - Décompressez le ZIP pour obtenir le fichier JSON</li>
                    <li><a href="https://data.assemblee-nationale.fr/static/openData/repository/15/questions/questions_ecrites/Questions_ecrites.json.zip" target="_blank">15e législature (2017-2022)</a> - Décompressez le ZIP pour obtenir le fichier JSON</li>
                </ul>
                <p><strong>Ensuite :</strong> Importez le fichier JSON ci-dessous. L'outil extraira automatiquement toutes les questions sur le handicap avec le texte complet des questions et réponses, les groupes politiques, les statuts, etc.</p>
            </div>

            <div class="control-group">
                <label for="fileInput">Importer le fichier JSON (décompressé) :</label>
                <input type="file" id="fileInput" accept=".json" aria-describedby="file-help">
                <small id="file-help">Sélectionnez le fichier Questions_ecrites.json décompressé</small>
            </div>

            <div class="control-group">
                <label for="keywords">Mots-clés à rechercher (séparés par des virgules) :</label>
                <input type="text" id="keywords" value="handicap,handicapé,handicapée,AAH,MDPH,PCH,RQTH,ESAT,IME,AESH,autisme,autiste,handicapés" placeholder="handicap, AAH, MDPH...">
                <small>L'outil cherchera ces mots-clés dans le texte des questions, des réponses et des rubriques</small>
            </div>

            <div class="btn-group">
                <button onclick="traiterFichierJSON()" id="btnProcess">Analyser le fichier</button>
                <button onclick="exporterCSV()" id="btnCSV" disabled>Exporter en CSV</button>
                <button onclick="exporterExcel()" id="btnExcel" disabled>Exporter en Excel</button>
            </div>

            <div id="status" class="status" role="status" aria-live="polite"></div>
        </div>

        <!-- ONGLET STATISTIQUES -->
        <div id="tab-stats" class="tab-content">
            <h2>Statistiques globales</h2>
            <div class="stats" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Aucune donnée</div>
                </div>
            </div>

            <div id="advancedStats" style="display:none;">
                <div class="stat-section">
                    <h3>Questions par groupe politique</h3>
                    <p style="color: #666; margin-bottom: 15px;">Nombre de questions posées et nombre de réponses reçues par groupe politique</p>
                    <ul class="stat-list" id="statsByGroupe"></ul>
                </div>

                <div class="stat-section">
                    <h3>Taux de réponse par groupe politique</h3>
                    <p style="color: #666; margin-bottom: 15px;">Pourcentage de questions ayant reçu une réponse du gouvernement par groupe</p>
                    <ul class="stat-list" id="tauxReponseGroupe"></ul>
                </div>

                <div class="stat-section">
                    <h3>Questions par thématique</h3>
                    <p style="color: #666; margin-bottom: 15px;">Répartition des questions selon les rubriques officielles</p>
                    <ul class="stat-list" id="statsByTheme"></ul>
                </div>

                <div class="stat-section">
                    <h3>Top 15 des auteurs les plus actifs</h3>
                    <p style="color: #666; margin-bottom: 15px;">Députés/Sénateurs ayant posé le plus de questions sur le handicap</p>
                    <ul class="stat-list" id="statsByAuteur"></ul>
                </div>

                <div class="stat-section">
                    <h3>Évolution par année</h3>
                    <p style="color: #666; margin-bottom: 15px;">Nombre de questions posées et répondues par année</p>
                    <ul class="stat-list" id="statsByAnnee"></ul>
                </div>
            </div>
        </div>

        <!-- ONGLET RÉSULTATS -->
        <div id="tab-resultats" class="tab-content">
            <div class="filters">
                <h3>Filtrer les résultats :</h3>
                <div class="filter-row">
                    <div>
                        <label for="filterStatut">Statut :</label>
                        <select id="filterStatut" onchange="appliquerFiltres()">
                            <option value="">Tous</option>
                            <option value="Répondu">Répondu</option>
                            <option value="En attente">En attente</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAnnee">Année :</label>
                        <select id="filterAnnee" onchange="appliquerFiltres()">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterGroupe">Groupe politique :</label>
                        <select id="filterGroupe" onchange="appliquerFiltres()">
                            <option value="">Tous</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterTheme">Thématique :</label>
                        <select id="filterTheme" onchange="appliquerFiltres()">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterAuteur">Auteur :</label>
                        <select id="filterAuteur" onchange="appliquerFiltres()">
                            <option value="">Tous</option>
                        </select>
                    </div>
                </div>
            </div>

            <h2>Questions trouvées (<span id="questionCount">0</span>)</h2>
            <div style="overflow-x: auto;">
                <table id="questionsTable">
                    <thead>
                        <tr>
                            <th scope="col">Numéro</th>
                            <th scope="col">Date</th>
                            <th scope="col">Auteur</th>
                            <th scope="col">Groupe</th>
                            <th scope="col">Thème</th>
                            <th scope="col">Question</th>
                            <th scope="col">Statut</th>
                            <th scope="col">Lien</th>
                        </tr>
                    </thead>
                    <tbody id="questionsBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                Importez d'abord un fichier de données dans l'onglet "Import de données"
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>Propulsé par Ti Racoon</p>
        </footer>
    </div>
<script>
        let toutesLesQuestions = [];
        let questionsFiltrees = [];

        // Gestion des onglets
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Afficher l'onglet sélectionné
            document.querySelector(`.tab:nth-child(${tabName === 'import' ? 1 : tabName === 'stats' ? 2 : 3})`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function afficherStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status show ' + type;
        }

        async function traiterFichierJSON() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                afficherStatus('Veuillez sélectionner un fichier JSON.', 'error');
                return;
            }

            afficherStatus('Lecture du fichier en cours...', 'info');

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                afficherStatus('Analyse des questions en cours... Cela peut prendre quelques secondes.', 'info');
                
                toutesLesQuestions = [];
                const keywords = document.getElementById('keywords').value.toLowerCase().split(',').map(k => k.trim());
                
                // Parser selon le format Open Data Assemblée Nationale
                const questions = data.questions || data;
                
                let compteur = 0;
                for (const q of questions) {
                    const texteQuestion = (q.texteQuestion || '').toLowerCase();
                    const texteReponse = (q.texteReponse || '').toLowerCase();
                    const rubrique = (q.rubrique || '').toLowerCase();
                    
                    // Vérifier si la question contient un des mots-clés
                    const contientMotCle = keywords.some(kw => 
                        texteQuestion.includes(kw) || 
                        texteReponse.includes(kw) || 
                        rubrique.includes(kw)
                    );
                    
                    if (contientMotCle) {
                        compteur++;
                        
                        // Extraire le nom du député
                        let nomDepute = 'Non spécifié';
                        let groupeDepute = 'Non spécifié';
                        
                        if (q.auteur) {
                            if (typeof q.auteur === 'string') {
                                nomDepute = q.auteur;
                            } else if (q.auteur.nom) {
                                nomDepute = q.auteur.nom;
                                groupeDepute = q.auteur.groupe || 'Non spécifié';
                            }
                        }
                        
                        // Extraire le groupe si disponible ailleurs
                        if (groupeDepute === 'Non spécifié' && q.groupe) {
                            groupeDepute = q.groupe;
                        }
                        
                        // Déterminer le statut
                        const aReponse = q.texteReponse && q.texteReponse.trim().length > 0;
                        
                        toutesLesQuestions.push({
                            assemblee: 'AN',
                            numero: q.numero || q.numQuestion || 'N/A',
                            date: q.datePublication || q.dateQuestion || '',
                            auteur: nomDepute,
                            groupe: groupeDepute,
                            theme: q.rubrique || q.theme || 'Non spécifié',
                            question: (q.texteQuestion || '').substring(0, 200),
                            questionComplete: q.texteQuestion || '',
                            reponseComplete: q.texteReponse || '',
                            statut: aReponse ? 'Répondu' : 'En attente',
                            lien: q.url || `https://questions.assemblee-nationale.fr/q${q.legislature || '16'}/${q.numero}QE.htm`
                        });
                    }
                    
                    // Afficher la progression tous les 1000 éléments
                    if (compteur % 1000 === 0 && compteur > 0) {
                        afficherStatus(`Analyse en cours... ${compteur} questions trouvées`, 'info');
                        await new Promise(resolve => setTimeout(resolve, 10)); // Laisser le navigateur respirer
                    }
                }
                
                if (toutesLesQuestions.length === 0) {
                    afficherStatus('Aucune question trouvée avec les mots-clés sélectionnés.', 'warning');
                } else {
                    afficherStatus(`Analyse terminée. ${toutesLesQuestions.length} questions trouvées sur le handicap.`, 'success');
                    afficherResultats();
                    genererStatistiquesAvancees();
                    document.getElementById('btnCSV').disabled = false;
                    document.getElementById('btnExcel').disabled = false;
                    
                    // Basculer automatiquement vers l'onglet statistiques
                    setTimeout(() => switchTab('stats'), 1000);
                }
            } catch (error) {
                afficherStatus('Erreur lors de la lecture du fichier : ' + error.message, 'error');
                console.error(error);
            }
        }

        function genererStatistiquesAvancees() {
            // Afficher la section des stats avancées
            document.getElementById('advancedStats').style.display = 'block';
            
            // Stats par groupe politique
            const parGroupe = {};
            toutesLesQuestions.forEach(q => {
                if (!parGroupe[q.groupe]) {
                    parGroupe[q.groupe] = { total: 0, repondues: 0 };
                }
                parGroupe[q.groupe].total++;
                if (q.statut === 'Répondu') {
                    parGroupe[q.groupe].repondues++;
                }
            });

            const statsByGroupe = document.getElementById('statsByGroupe');
            statsByGroupe.innerHTML = '';
            Object.entries(parGroupe)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([groupe, stats]) => {
                    const tauxReponse = ((stats.repondues / stats.total) * 100).toFixed(1);
                    statsByGroupe.innerHTML += `
                        <li>
                            <span class="name">${groupe}</span>
                            <span class="detail">${stats.repondues} réponses / ${stats.total} questions</span>
                            <span class="value">${stats.total}</span>
                        </li>
                    `;
                });

            // Taux de réponse par groupe
            const tauxReponseGroupe = document.getElementById('tauxReponseGroupe');
            tauxReponseGroupe.innerHTML = '';
            Object.entries(parGroupe)
                .sort((a, b) => (b[1].repondues/b[1].total) - (a[1].repondues/a[1].total))
                .forEach(([groupe, stats]) => {
                    const taux = ((stats.repondues / stats.total) * 100).toFixed(1);
                    const pourcentage = (stats.repondues / stats.total) * 100;
                    tauxReponseGroupe.innerHTML += `
                        <li>
                            <span class="name">${groupe}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${pourcentage}%">${taux}%</div>
                            </div>
                        </li>
                    `;
                });
// Stats par thématique
            const parTheme = {};
            toutesLesQuestions.forEach(q => {
                parTheme[q.theme] = (parTheme[q.theme] || 0) + 1;
            });

            const statsByTheme = document.getElementById('statsByTheme');
            statsByTheme.innerHTML = '';
            Object.entries(parTheme)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .forEach(([theme, count]) => {
                    const pourcentage = ((count / toutesLesQuestions.length) * 100).toFixed(1);
                    statsByTheme.innerHTML += `
                        <li>
                            <span class="name">${theme}</span>
                            <span class="detail">${pourcentage}% du total</span>
                            <span class="value">${count}</span>
                        </li>
                    `;
                });

            // Stats par auteur
            const parAuteur = {};
            toutesLesQuestions.forEach(q => {
                if (!parAuteur[q.auteur]) {
                    parAuteur[q.auteur] = { total: 0, repondues: 0, groupe: q.groupe };
                }
                parAuteur[q.auteur].total++;
                if (q.statut === 'Répondu') {
                    parAuteur[q.auteur].repondues++;
                }
            });

            const statsByAuteur = document.getElementById('statsByAuteur');
            statsByAuteur.innerHTML = '';
            Object.entries(parAuteur)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 15)
                .forEach(([auteur, stats]) => {
                    const tauxReponse = ((stats.repondues / stats.total) * 100).toFixed(1);
                    statsByAuteur.innerHTML += `
                        <li>
                            <span class="name">${auteur} (${stats.groupe})</span>
                            <span class="detail">${stats.repondues} réponses / ${stats.total} questions (${tauxReponse}%)</span>
                            <span class="value">${stats.total}</span>
                        </li>
                    `;
                });

            // Stats par année
            const parAnnee = {};
            toutesLesQuestions.forEach(q => {
                const annee = q.date.substring(0, 4);
                if (!parAnnee[annee]) {
                    parAnnee[annee] = { total: 0, repondues: 0 };
                }
                parAnnee[annee].total++;
                if (q.statut === 'Répondu') {
                    parAnnee[annee].repondues++;
                }
            });

            const statsByAnnee = document.getElementById('statsByAnnee');
            statsByAnnee.innerHTML = '';
            Object.entries(parAnnee)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([annee, stats]) => {
                    const tauxReponse = ((stats.repondues / stats.total) * 100).toFixed(1);
                    statsByAnnee.innerHTML += `
                        <li>
                            <span class="name">${annee}</span>
                            <span class="detail">${stats.repondues} réponses / ${stats.total} questions</span>
                            <span class="value">${tauxReponse}%</span>
                        </li>
                    `;
                });
        }

        function afficherResultats() {
            questionsFiltrees = [...toutesLesQuestions];
            
            // Statistiques globales
            const totalQuestions = toutesLesQuestions.length;
            const avecReponse = toutesLesQuestions.filter(q => q.statut === 'Répondu').length;
            const sansReponse = totalQuestions - avecReponse;
            const tauxReponseGlobal = totalQuestions > 0 ? ((avecReponse / totalQuestions) * 100).toFixed(1) : 0;

            // Compter le nombre de groupes et d'auteurs uniques
            const groupesUniques = [...new Set(toutesLesQuestions.map(q => q.groupe))].length;
            const auteursUniques = [...new Set(toutesLesQuestions.map(q => q.auteur))].length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalQuestions}</div>
                    <div class="stat-label">Questions totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avecReponse}</div>
                    <div class="stat-label">Avec réponse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${sansReponse}</div>
                    <div class="stat-label">Sans réponse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tauxReponseGlobal}%</div>
                    <div class="stat-label">Taux de réponse</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${auteursUniques}</div>
                    <div class="stat-label">Auteurs différents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${groupesUniques}</div>
                    <div class="stat-label">Groupes politiques</div>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = statsHTML;

            // Peupler les filtres
            const annees = [...new Set(toutesLesQuestions.map(q => q.date.substring(0, 4)))].filter(a => a).sort().reverse();
            const filterAnnee = document.getElementById('filterAnnee');
            filterAnnee.innerHTML = '<option value="">Toutes</option>';
            annees.forEach(annee => {
                filterAnnee.innerHTML += `<option value="${annee}">${annee}</option>`;
            });

            const groupes = [...new Set(toutesLesQuestions.map(q => q.groupe))].sort();
            const filterGroupe = document.getElementById('filterGroupe');
            filterGroupe.innerHTML = '<option value="">Tous</option>';
            groupes.forEach(groupe => {
                filterGroupe.innerHTML += `<option value="${groupe}">${groupe}</option>`;
            });

            const themes = [...new Set(toutesLesQuestions.map(q => q.theme))].sort();
            const filterTheme = document.getElementById('filterTheme');
            filterTheme.innerHTML = '<option value="">Toutes</option>';
            themes.forEach(theme => {
                filterTheme.innerHTML += `<option value="${theme}">${theme}</option>`;
            });

            const auteurs = [...new Set(toutesLesQuestions.map(q => q.auteur))].sort();
            const filterAuteur = document.getElementById('filterAuteur');
            filterAuteur.innerHTML = '<option value="">Tous</option>';
            auteurs.forEach(auteur => {
                filterAuteur.innerHTML += `<option value="${auteur}">${auteur}</option>`;
            });

            afficherTableau();
        }

        function afficherTableau() {
            const tbody = document.getElementById('questionsBody');
            tbody.innerHTML = '';

            if (questionsFiltrees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Aucune question ne correspond aux filtres sélectionnés
                        </td>
                    </tr>
                `;
                document.getElementById('questionCount').textContent = '0';
                return;
            }

            questionsFiltrees.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${q.numero}</td>
                    <td>${q.date}</td>
                    <td>${q.auteur}</td>
                    <td>${q.groupe}</td>
                    <td>${q.theme}</td>
                    <td title="${q.question}">${q.question.substring(0, 100)}...</td>
                    <td><span class="badge ${q.statut === 'Répondu' ? 'badge-success' : 'badge-warning'}">${q.statut}</span></td>
                    <td><a href="${q.lien}" target="_blank" class="question-link" aria-label="Voir la question complète numéro ${q.numero}">Voir</a></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('questionCount').textContent = questionsFiltrees.length;
        }
function appliquerFiltres() {
            const filterStatut = document.getElementById('filterStatut').value;
            const filterAnnee = document.getElementById('filterAnnee').value;
            const filterGroupe = document.getElementById('filterGroupe').value;
            const filterTheme = document.getElementById('filterTheme').value;
            const filterAuteur = document.getElementById('filterAuteur').value;

            questionsFiltrees = toutesLesQuestions.filter(q => {
                if (filterStatut && q.statut !== filterStatut) return false;
                if (filterAnnee && !q.date.startsWith(filterAnnee)) return false;
                if (filterGroupe && q.groupe !== filterGroupe) return false;
                if (filterTheme && q.theme !== filterTheme) return false;
                if (filterAuteur && q.auteur !== filterAuteur) return false;
                return true;
            });

            afficherTableau();
        }

        function exporterCSV() {
            const dataToExport = questionsFiltrees.map(q => ({
                'Numéro': q.numero,
                'Date': q.date,
                'Auteur': q.auteur,
                'Groupe politique': q.groupe,
                'Thème': q.theme,
                'Question (extrait)': q.question,
                'Question complète': q.questionComplete || q.question,
                'Réponse complète': q.reponseComplete || '',
                'Statut': q.statut,
                'Lien': q.lien
            }));
            
            const csv = Papa.unparse(dataToExport);
            telechargerFichier(csv, 'questions_handicap_' + new Date().toISOString().split('T')[0] + '.csv', 'text/csv;charset=utf-8;');
            afficherStatus(`Fichier CSV exporté avec ${questionsFiltrees.length} questions.`, 'success');
        }

        function exporterExcel() {
            const dataToExport = questionsFiltrees.map(q => ({
                'Numéro': q.numero,
                'Date': q.date,
                'Auteur': q.auteur,
                'Groupe politique': q.groupe,
                'Thème': q.theme,
                'Question (extrait)': q.question,
                'Question complète': q.questionComplete || q.question,
                'Réponse complète': q.reponseComplete || '',
                'Statut': q.statut,
                'Lien': q.lien
            }));
            
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            
            // Ajuster la largeur des colonnes
            const colWidths = [
                { wch: 10 },  // Numéro
                { wch: 12 },  // Date
                { wch: 25 },  // Auteur
                { wch: 25 },  // Groupe
                { wch: 30 },  // Thème
                { wch: 40 },  // Question extrait
                { wch: 80 },  // Question complète
                { wch: 80 },  // Réponse complète
                { wch: 12 },  // Statut
                { wch: 50 }   // Lien
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Questions');
            
            // Ajouter une feuille avec les statistiques
            const statsData = [];
            statsData.push({ 'Statistique': 'Total questions', 'Valeur': toutesLesQuestions.length });
            statsData.push({ 'Statistique': 'Questions répondues', 'Valeur': toutesLesQuestions.filter(q => q.statut === 'Répondu').length });
            statsData.push({ 'Statistique': 'Questions sans réponse', 'Valeur': toutesLesQuestions.filter(q => q.statut === 'En attente').length });
            statsData.push({ 'Statistique': 'Taux de réponse', 'Valeur': ((toutesLesQuestions.filter(q => q.statut === 'Répondu').length / toutesLesQuestions.length) * 100).toFixed(1) + '%' });
            statsData.push({ 'Statistique': '', 'Valeur': '' });
            statsData.push({ 'Statistique': 'Par groupe politique', 'Valeur': '' });
            
            // Ajouter les stats par groupe
            const parGroupe = {};
            toutesLesQuestions.forEach(q => {
                if (!parGroupe[q.groupe]) {
                    parGroupe[q.groupe] = { total: 0, repondues: 0 };
                }
                parGroupe[q.groupe].total++;
                if (q.statut === 'Répondu') {
                    parGroupe[q.groupe].repondues++;
                }
            });
            
            Object.entries(parGroupe).sort((a, b) => b[1].total - a[1].total).forEach(([groupe, stats]) => {
                statsData.push({ 
                    'Statistique': groupe, 
                    'Valeur': `${stats.total} questions (${stats.repondues} réponses, ${((stats.repondues/stats.total)*100).toFixed(1)}%)` 
                });
            });
            
            const wsStats = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, wsStats, 'Statistiques');
            
            XLSX.writeFile(wb, 'questions_handicap_' + new Date().toISOString().split('T')[0] + '.xlsx');
            afficherStatus(`Fichier Excel exporté avec ${questionsFiltrees.length} questions et statistiques.`, 'success');
        }

        function telechargerFichier(contenu, nomFichier, type) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + contenu], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomFichier;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

